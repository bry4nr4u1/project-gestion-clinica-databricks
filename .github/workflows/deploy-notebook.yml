name: Despliegue din√°mico de notebooks de databricks
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Install jq & curl
      run: sudo apt-get update && sudo apt-get install -y jq curl
    
    - name: Exportar m√∫ltiples notebooks
      run: |
        ORIGIN_HOST=${{ secrets.DATABRICKS_ORIGIN_HOST }}
        ORIGIN_TOKEN=${{ secrets.DATABRICKS_ORIGIN_TOKEN }}
        NOTEBOOK_BASE="/Workspace/Users/cursosestudiosbrscc03@outlook.com/project-gestion-clinica-databricks/proceso"
        
        # Definir notebooks con sus extensiones (basado en su lenguaje)
        declare -A NOTEBOOKS=(
          ["preparacion-ambiente"]="sql"
          ["extraer-data-cirugia"]="py"
          ["extraer-data-consultas-medicas"]="py"
          ["extraer-data-historial-pacientes"]="py"
          ["extraer-data-medicamento"]="py"
          ["extraer-data-medico"]="py"
          ["extraer-data-paciente"]="py"
          ["transformar-data-clinica"]="py"
          ["cargar-data-clinica"]="py"
          ["gestion-permisos-clinica"]="sql" 
        )
        
        mkdir -p notebooks_to_deploy
        
        for nb in "${!NOTEBOOKS[@]}"; do
          ext="${NOTEBOOKS[$nb]}"
          echo "Exportando $nb como .$ext..."
          curl -s -X GET \
            -H "Authorization: Bearer $ORIGIN_TOKEN" \
            "$ORIGIN_HOST/api/2.0/workspace/export?path=$NOTEBOOK_BASE/$nb&format=SOURCE&direct_download=true" \
            --output "notebooks_to_deploy/$nb.$ext"
        done
    
    - name: Deploy notebooks to Destination Workspace
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        DEST_BASE="/prod/etl"
        
        echo "Creando carpeta $DEST_BASE si no existe..."
        curl -s -X POST \
          -H "Authorization: Bearer $DEST_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"path\":\"$DEST_BASE\"}" \
          "$DEST_HOST/api/2.0/workspace/mkdirs"
        
        for file in notebooks_to_deploy/*; do
          name=$(basename "$file")
          name_no_ext="${name%.*}"
          extension="${name##*.}"
          dest_path="$DEST_BASE/$name_no_ext"
          
          # Detectar lenguaje seg√∫n extensi√≥n
          case "$extension" in
            py)
              language="PYTHON"
              ;;
            sql)
              language="SQL"
              ;;
            scala)
              language="SCALA"
              ;;
            r)
              language="R"
              ;;
            *)
              echo "‚ö†Ô∏è Extensi√≥n no soportada: $extension. Omitiendo $file"
              continue
              ;;
          esac
          
          echo "Eliminando notebook existente si existe: $dest_path"
          curl -s -X POST \
            -H "Authorization: Bearer $DEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"path\":\"$dest_path\", \"recursive\":false}" \
            "$DEST_HOST/api/2.0/workspace/delete" 2>/dev/null || true
          
          echo "Importando $file ‚Üí $dest_path (Lenguaje: $language)"
          
          # Codificar contenido en base64
          content_base64=$(base64 -w 0 "$file")
          
          # Crear JSON payload
          json_payload=$(jq -n \
            --arg path "$dest_path" \
            --arg content "$content_base64" \
            --arg lang "$language" \
            '{path: $path, format: "SOURCE", language: $lang, content: $content}')
          
          response=$(curl -s -X POST \
            -H "Authorization: Bearer $DEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$json_payload" \
            "$DEST_HOST/api/2.0/workspace/import")
          
          if echo "$response" | jq -e '.error_code' > /dev/null 2>&1; then
            echo "‚ùå Error: $response"
            exit 1
          else
            echo "‚úÖ Importado correctamente"
          fi
        done
    
    - name: Check if workflow exists and delete if necessary
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        WORKFLOW_NAME="wf_carga_datos_clinica"
        
        echo "Verificando si existe el workflow: $WORKFLOW_NAME"
        
        # Listar todos los workflows y buscar por nombre
        workflows_response=$(curl -s -X GET \
          -H "Authorization: Bearer $DEST_TOKEN" \
          "$DEST_HOST/api/2.1/jobs/list")
        
        # Extraer job_id si existe el workflow
        existing_job_id=$(echo "$workflows_response" | jq -r --arg name "$WORKFLOW_NAME" '.jobs[]? | select(.settings.name == $name) | .job_id')
        
        if [ "$existing_job_id" != "" ] && [ "$existing_job_id" != "null" ]; then
          echo "Workflow encontrado con ID: $existing_job_id. Eliminando..."
          delete_response=$(curl -s -X POST \
            -H "Authorization: Bearer $DEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"job_id\": $existing_job_id}" \
            "$DEST_HOST/api/2.1/jobs/delete")
          echo "Delete response: $delete_response"
        else
          echo "No se encontr√≥ workflow existente con nombre: $WORKFLOW_NAME"
        fi
    
    - name: Get existing cluster ID
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        CLUSTER_NAME="cluster_etl"
        
        echo "Buscando cluster existente: $CLUSTER_NAME"
        
        # Obtener lista de clusters
        clusters_response=$(curl -s -X GET \
          -H "Authorization: Bearer $DEST_TOKEN" \
          "$DEST_HOST/api/2.0/clusters/list")
        
        echo "Clusters response: $clusters_response"
        
        # Extraer cluster_id del cluster especificado
        cluster_id=$(echo "$clusters_response" | jq -r --arg name "$CLUSTER_NAME" '.clusters[]? | select(.cluster_name == $name) | .cluster_id')
        
        if [ "$cluster_id" != "" ] && [ "$cluster_id" != "null" ]; then
          echo "‚úÖ Cluster encontrado: $CLUSTER_NAME con ID: $cluster_id"
          echo "CLUSTER_ID=$cluster_id" >> $GITHUB_ENV
        else
          echo "‚ùå No se encontr√≥ el cluster: $CLUSTER_NAME"
          echo "Clusters disponibles:"
          echo "$clusters_response" | jq -r '.clusters[]? | .cluster_name'
          exit 1
        fi
    
    - name: Create Databricks Workflow wf_carga_datos_clinica
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        DEST_BASE="/prod/etl"
        CLUSTER_ID="${{ env.CLUSTER_ID }}"
        
        echo "Creando workflow: wf_carga_datos_clinica con cluster existente ID: $CLUSTER_ID"
        
        # Crear el JSON del workflow usando cluster existente
        cat > workflow_config.json << EOF
        {
          "name": "wf_carga_datos_clinica",
          "format": "MULTI_TASK",
          "tasks": [
            {
              "task_key": "Preparacion-Ambiente",
              "description": "Ejecuta notebook -> preparacion-ambiente",
              "notebook_task": {
                "notebook_path": "/prod/etl/preparacion-ambiente",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "nombre_container": "unit-catalog-clinica",
                  "nombre_storage": "adlsbrscceu2d01",
                  "nombre_container_raw": "raw",
                  "nombre_storage_raw": "dtlkbrscceu2d01"
                }                
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2            
            },
            {
              "task_key": "Extraer-data-cirugia",
              "description": "Ejecuta notebook -> extraer-data-cirugia",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-cirugia",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "raw_datalake": "dtlkbrscceu2d01",
                  "raw_container": "raw",
                  "raw_file": "cirugia.csv",
                  "bronze_schema": "bronze",
                  "bronze_table": "cirugia"                                 
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },
            {
              "task_key": "Extraer-data-consultas-medicas",
              "description": "Ejecuta notebook -> extraer-data-consultas-medicas",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-consultas-medicas",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "raw_datalake": "dtlkbrscceu2d01",
                  "raw_container": "raw",
                  "raw_file": "consultas_medicas.csv",
                  "bronze_schema": "bronze",
                  "bronze_table": "consultas_medicas"                                 
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },
            {
              "task_key": "Extraer-data-medicamento",
              "description": "Ejecuta notebook -> extraer-data-medicamento",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-medicamento",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "raw_datalake": "dtlkbrscceu2d01",
                  "raw_container": "raw",
                  "raw_file": "medicamento.csv",
                  "bronze_schema": "bronze",
                  "bronze_table": "medicamento"                                 
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },
            {
              "task_key": "Extraer-data-medico",
              "description": "Ejecuta notebook -> extraer-data-medico",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-medico",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "raw_datalake": "dtlkbrscceu2d01",
                  "raw_container": "raw",
                  "raw_file": "medico.csv",
                  "bronze_schema": "bronze",
                  "bronze_table": "medico"                                 
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },
            {
              "task_key": "Extraer-data-paciente",
              "description": "Ejecuta notebook -> extraer-data-paciente",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-paciente",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "raw_datalake": "dtlkbrscceu2d01",
                  "raw_container": "raw",
                  "raw_file": "paciente.csv",
                  "bronze_schema": "bronze",
                  "bronze_table": "paciente"                                 
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },
            {
              "task_key": "Extraer-data-historial-pacientes",
              "description": "Ejecuta notebook -> extraer-data-historial-pacientes",
              "notebook_task": {
                "notebook_path": "/prod/etl/extraer-data-historial-pacientes",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "cosmos_account": "codbbrscceu2d01",
                  "cosmos_scope": "accessScopeforCosmosDB",
                  "cosmos_secret": "cosmosdbKey",
                  "cosmos_database": "clinica",
                  "cosmos_container": "raw",
                  "bronze_schema": "bronze",
                  "bronze_table": "historial_pacientes"                          
                }   
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Preparacion-Ambiente"
                }
              ]
            },   
            {
              "task_key": "Transformar-datos-clinica",
              "description": "Ejecuta notebook -> transformar-data-clinica",
              "notebook_task": {
                "notebook_path": "/prod/etl/transformar-data-clinica",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "bronze_schema": "bronze",
                  "bronze_pacientes": "paciente",
                  "bronze_medicos": "medico",
                  "bronze_medicamentos": "medicamento",
                  "bronze_cirugias": "cirugia",
                  "bronze_consultas_medicas": "consultas_medicas",
                  "bronze_historial_paciente": "historial_pacientes",
                  "silver_schema": "silver",
                  "silver_pacientes": "paciente",
                  "silver_medicos": "medico",
                  "silver_medicamentos": "medicamento",
                  "silver_cirugias": "cirugia",
                  "silver_consultas_medicas": "consultas_medicas",
                  "silver_historial_pacientes_medicamentos": "historial_pacientes_medicamentos",
                  "silver_historial_pacientes_cirugias": "historial_pacientes_cirugias"
                }
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Extraer-data-cirugia"
                },
                {
                  "task_key": "Extraer-data-consultas-medicas"
                },
                {
                  "task_key": "Extraer-data-medicamento"
                },
                {
                  "task_key": "Extraer-data-medico"
                },
                {
                  "task_key": "Extraer-data-paciente"
                },
                {
                  "task_key": "Extraer-data-historial-pacientes"
                }
              ]
            },
            {
              "task_key": "Cargar-datos-clinica",
              "description": "Ejecuta notebook -> cargar-data-clinica",
              "notebook_task": {
                "notebook_path": "/prod/etl/cargar-data-clinica",
                "source": "WORKSPACE",
                "base_parameters": {
                  "catalogo": "catalogo_clinica",
                  "silver_schema": "silver",
                  "silver_hist_pac_med_table": "historial_pacientes_medicamentos",
                  "silver_hist_pac_cir_table": "historial_pacientes_cirugias",
                  "silver_paciente_table": "paciente",
                  "silver_medico_table": "medico",
                  "silver_consultas_medicas_table": "consultas_medicas",
                  "silver_medicamento_table": "medicamento",
                  "silver_cirugia_table": "cirugia",
                  "gold_schema": "gold",
                  "gold_pac_per_cli_table": "paciente_perfil_clinico",
                  "gold_consulta_por_medico_table": "consulta_por_medico",
                  "gold_ingreso_por_especialidad_table": "ingresos_por_especialidad",
                  "gold_medicamentos_consumo_table": "medicamentos_consumo"
                }                
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Transformar-datos-clinica"
                }
              ]
            },
            {
              "task_key": "Gestion-Permisos-Clinica",
              "description": "Ejecuta notebook -> gestion-permisos-clinica",
              "notebook_task": {
                "notebook_path": "/prod/etl/gestion-permisos-clinica",
                "source": "WORKSPACE"              
              },
              "existing_cluster_id": "$CLUSTER_ID",
              "timeout_seconds": 3600,
              "max_retries": 2,
              "depends_on": [
                {
                  "task_key": "Cargar-datos-clinica"
                }
              ]
            } 
          ],
          "schedule": {
            "quartz_cron_expression": "0 0 8 * * ?",
            "timezone_id": "America/Lima",
            "pause_status": "PAUSED"
          },
          "email_notifications": {
            "on_failure": [],
            "on_success": [],
            "no_alert_for_skipped_runs": false
          },
          "webhook_notifications": {},
          "timeout_seconds": 7200,
          "max_concurrent_runs": 1,
          "tags": {
            "environment": "production",
            "created_by": "github_actions",
            "project": "automated_deployment",
            "cluster_used": "cluster_etl"
          }
        }
        EOF
        
        # Crear el workflow
        create_response=$(curl -s -X POST \
          -H "Authorization: Bearer $DEST_TOKEN" \
          -H "Content-Type: application/json" \
          -d @workflow_config.json \
          "$DEST_HOST/api/2.1/jobs/create")
        
        echo "Workflow creation response: $create_response"
        
        # Extraer job_id del response
        job_id=$(echo "$create_response" | jq -r '.job_id')
        
        if [ "$job_id" != "" ] && [ "$job_id" != "null" ]; then
          echo "‚úÖ Workflow 'wf_carga_datos_clinica' creado exitosamente con ID: $job_id"
          
          # Obtener detalles del workflow creado
          workflow_details=$(curl -s -X GET \
            -H "Authorization: Bearer $DEST_TOKEN" \
            "$DEST_HOST/api/2.1/jobs/get?job_id=$job_id")
          
          echo "Detalles del workflow:"
          echo "$workflow_details" | jq '.settings | {name, tasks: (.tasks | map({task_key, notebook_task: .notebook_task.notebook_path}))}'
        else
          echo "‚ùå Error al crear el workflow"
          echo "Response completo: $create_response"
          exit 1
        fi
    
    - name: Validate Workflow Configuration
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        WORKFLOW_NAME="wf_carga_datos_clinica"
        
        echo "üîç Validando la configuraci√≥n del workflow creado..."
        
        # Obtener lista de workflows y encontrar el reci√©n creado
        workflows_list=$(curl -s -X GET \
          -H "Authorization: Bearer $DEST_TOKEN" \
          "$DEST_HOST/api/2.1/jobs/list")
        
        job_id=$(echo "$workflows_list" | jq -r --arg name "$WORKFLOW_NAME" '.jobs[]? | select(.settings.name == $name) | .job_id')
        
        if [ "$job_id" != "" ] && [ "$job_id" != "null" ]; then
          echo "‚úÖ Workflow encontrado con ID: $job_id"
          
          # Obtener configuraci√≥n detallada
          job_details=$(curl -s -X GET \
            -H "Authorization: Bearer $DEST_TOKEN" \
            "$DEST_HOST/api/2.1/jobs/get?job_id=$job_id")
          
          echo "üìã Resumen del workflow:"
          echo "Nombre: $(echo "$job_details" | jq -r '.settings.name')"
          echo "N√∫mero de tareas: $(echo "$job_details" | jq '.settings.tasks | length')"
          echo ""
          echo "üìù Tareas configuradas:"
          echo "$job_details" | jq -r '.settings.tasks[] | "- " + .task_key + " ‚Üí " + .notebook_task.notebook_path'
          echo ""
          echo "üñ•Ô∏è  Cluster configurado:"
          echo "Cluster ID: $(echo "$job_details" | jq -r '.settings.tasks[0].existing_cluster_id')"
          echo "Cluster Name: cluster_etl (reutilizado)"
          
        else
          echo "‚ùå No se pudo encontrar el workflow creado"
          exit 1
        fi
    
    - name: Execute Workflow wf_carga_datos_clinica
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        WORKFLOW_NAME="wf_carga_datos_clinica"
        
        echo "üöÄ Ejecutando workflow: $WORKFLOW_NAME"
        
        # Obtener job_id del workflow
        workflows_list=$(curl -s -X GET \
          -H "Authorization: Bearer $DEST_TOKEN" \
          "$DEST_HOST/api/2.1/jobs/list")
        
        job_id=$(echo "$workflows_list" | jq -r --arg name "$WORKFLOW_NAME" '.jobs[]? | select(.settings.name == $name) | .job_id')
        
        if [ "$job_id" != "" ] && [ "$job_id" != "null" ]; then
          echo "‚úÖ Workflow encontrado con ID: $job_id"
          
          # Ejecutar el workflow
          run_response=$(curl -s -X POST \
            -H "Authorization: Bearer $DEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"job_id\": $job_id}" \
            "$DEST_HOST/api/2.1/jobs/run-now")
          
          run_id=$(echo "$run_response" | jq -r '.run_id')
          
          if [ "$run_id" != "" ] && [ "$run_id" != "null" ]; then
            echo "üéØ Workflow ejecutado exitosamente!"
            echo "Run ID: $run_id"
            echo "WORKFLOW_RUN_ID=$run_id" >> $GITHUB_ENV
            echo "WORKFLOW_JOB_ID=$job_id" >> $GITHUB_ENV
            
            # Mostrar URL del workflow en ejecuci√≥n
            echo "üîó URL del workflow: $DEST_HOST/jobs/$job_id/runs/$run_id"
            
          else
            echo "‚ùå Error al ejecutar el workflow"
            echo "Response: $run_response"
            exit 1
          fi
        else
          echo "‚ùå No se pudo encontrar el workflow para ejecutar"
          exit 1
        fi
    
    - name: Monitor Workflow Execution
      run: |
        DEST_HOST=${{ secrets.DATABRICKS_DEST_HOST }}
        DEST_TOKEN=${{ secrets.DATABRICKS_DEST_TOKEN }}
        RUN_ID="${{ env.WORKFLOW_RUN_ID }}"
        JOB_ID="${{ env.WORKFLOW_JOB_ID }}"
        
        echo "üìä Monitoreando ejecuci√≥n del workflow..."
        echo "Job ID: $JOB_ID"
        echo "Run ID: $RUN_ID"
        
        # Monitorear por m√°ximo 10 minutos (600 segundos)
        max_wait_time=600
        wait_time=0
        check_interval=30
        
        while [ $wait_time -lt $max_wait_time ]; do
          # Obtener estado actual
          run_status=$(curl -s -X GET \
            -H "Authorization: Bearer $DEST_TOKEN" \
            "$DEST_HOST/api/2.1/jobs/runs/get?run_id=$RUN_ID")
          
          state=$(echo "$run_status" | jq -r '.state.life_cycle_state')
          result_state=$(echo "$run_status" | jq -r '.state.result_state // "RUNNING"')
          
          echo "‚è±Ô∏è  Estado actual: $state ($result_state) - Tiempo transcurrido: ${wait_time}s"
          
          # Mostrar progreso de las tareas
          echo "$run_status" | jq -r '.tasks[]? | "  üìã " + .task_key + ": " + .state.life_cycle_state + " (" + (.state.result_state // "RUNNING") + ")"'
          
          case "$state" in
            "TERMINATED")
              if [ "$result_state" = "SUCCESS" ]; then
                echo "üéâ ¬°Workflow completado exitosamente!"
                
                # Mostrar resumen final
                echo ""
                echo "üìà Resumen de ejecuci√≥n:"
                echo "$run_status" | jq -r '.tasks[]? | "‚úÖ " + .task_key + " ‚Üí " + (.state.result_state // "SUCCESS")'
                
                # Obtener duraci√≥n
                start_time=$(echo "$run_status" | jq -r '.start_time')
                end_time=$(echo "$run_status" | jq -r '.end_time')
                if [ "$start_time" != "null" ] && [ "$end_time" != "null" ]; then
                  duration=$((($end_time - $start_time) / 1000))
                  echo "‚è∞ Duraci√≥n total: ${duration} segundos"
                fi
                
                exit 0
              else
                echo "‚ùå Workflow termin√≥ con errores: $result_state"
                echo "üìã Detalles de las tareas:"
                echo "$run_status" | jq -r '.tasks[]? | "‚ùå " + .task_key + ": " + (.state.result_state // "UNKNOWN")'
                exit 1
              fi
              ;;
            "INTERNAL_ERROR"|"SKIPPED")
              echo "‚ùå Workflow fall√≥ con estado: $state"
              exit 1
              ;;
            *)
              # Estados: PENDING, RUNNING, TERMINATING
              echo "‚è≥ Workflow a√∫n ejecut√°ndose..."
              ;;
          esac
          
          sleep $check_interval
          wait_time=$((wait_time + check_interval))
        done
        
        echo "‚ö†Ô∏è  Timeout: El workflow a√∫n se est√° ejecutando despu√©s de $max_wait_time segundos"
        echo "üîó Verifica el estado en: $DEST_HOST/jobs/$JOB_ID/runs/$RUN_ID"
        echo "‚ÑπÔ∏è  El workflow seguir√° ejecut√°ndose en Databricks"
        exit 0
    
    - name: Clean up
      run: |
        rm -rf notebooks_to_deploy
        rm -f workflow_config.json
    
    - name: Done
      run: |
        echo "üéâ ¬°Despliegue y ejecuci√≥n completados exitosamente!"
        echo ""
        echo "üìä Resumen:"
        echo "‚úÖ Notebooks desplegados: ntbk_1, ntbk_2"
        echo "‚úÖ Workflow creado: wf_carga_datos_clinica"
        echo "‚úÖ Tareas configuradas:"
        echo "   - tarea1_notebook1 (ntbk_1)"
        echo "   - tarea2_notebook2 (ntbk_2)"
        echo "‚úÖ Cluster existente: cluster_etl configurado"
        echo "üöÄ Workflow ejecutado autom√°ticamente"
        echo ""
        echo "üîó Accede a tu workspace de Databricks para ver los resultados detallados"